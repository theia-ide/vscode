name: publish-monaco-editor-core-to-npmjs.org
on:
  push:
    branches:
      - monaco-editor-core-publish
env:
  NODE_OPTIONS: --max-old-space-size=8192
jobs:
  linux:
    name: Publish monaco-editor-core to NPM
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v2
      # should be aligned with https://github.com/microsoft/vscode/blob/8031c495a65de120560d27703c415eb44c3a99a1/.github/workflows/ci.yml#L22-L32
      - run: |
          sudo apt-get update
          sudo apt-get install -y libxkbfile-dev pkg-config libsecret-1-dev libxss1 dbus xvfb libgtk-3-0
          sudo cp build/azure-pipelines/linux/xvfb.init /etc/init.d/xvfb
          sudo chmod +x /etc/init.d/xvfb
          sudo update-rc.d xvfb defaults
          sudo service xvfb start
        name: Setup Build Environment
      - uses: actions/setup-node@v2
        with:
          node-version: 12
          registry-url: 'https://registry.npmjs.org'
          scope: '@theia'
      - run: rm -rf ~/.cache/node-gyp/
        name: Remove node-gyp
      - run: yarn --frozen-lockfile --network-timeout 180000
        name: Install dependencies
      - run: gulp editor-distro
        name: Prepare distribution
      - run: |
          cd out-monaco-editor-core
          npm publish --access public
        name: Publish to NPM
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
